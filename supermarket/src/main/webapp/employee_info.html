<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./element-ui/lib/theme-chalk/index.css">
    <script src="./js/vue.js"></script>
    <script src="./js/axios.min.js"></script>
    <script src="./element-ui/lib/index.js"></script>
    <style>
    body{
        margin: 0;
        padding: 0;
    }
    #app04{
        width: 100%;
        height: 100vh;
        background-color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-direction: column;
    /* background-color: red; */
    }
    #contents{
        width: 100%;
        height: 90%;
        /* background-color: red; */
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    .el-input{
        width: 100%;
        height: auto;
    }
    /* .el-form-item__label{
        width: 20%;
        height: auto;
    } */

    #an{
        text-align: center;
    }
    .el-form-item__label{
        padding: 0 6% 0 0;
    }
    #up{
        width: 100%;
        height: 10%;
        background-color: #F2F6FC;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
    }
    </style>
</head>
<body>
    <div id="app04">
        <div id="up">
            个人信息详情
        </div>
        <div id="contents">
            <el-form ref="form" :model="form" label-width="80px" :disabled="flag1" size="small">
                <el-form-item label="姓名">
                  <el-input v-model="form.name"></el-input>
                </el-form-item>

                <el-form-item label="性别">
                    <el-radio-group v-model="form.sex">
                      <el-radio label="男"></el-radio>
                      <el-radio label="女"></el-radio>
                    </el-radio-group>
                  </el-form-item>   

                  <el-form-item label="年龄">
                    <el-input v-model="form.age"></el-input>
                  </el-form-item>

                <el-form-item label="账号">
                    <el-input v-model="form.account"></el-input>
                  </el-form-item>
                  <el-form-item label="密码">
                    <el-input v-model="form.password"></el-input>
                  </el-form-item>
                  <el-form-item label="电话">
                    <el-input v-model="form.phone"></el-input>
                  </el-form-item>


                  
                <el-form-item label="地址">
                    <el-select v-model="form.province" placeholder="请选择活动区域">
                        <el-option
                                v-for="item in region1"
                                :key="item.area_id"
                                :label="item.name"
                                :value="item.name"
                        ></el-option>
                    </el-select>
                    <el-select v-model="form.city" placeholder="请选择活动区域">
                        <el-option
                                v-for="item in region2"
                                :key="item.area_id"
                                :label="item.name"
                                :value="item.name"
                        ></el-option>
                    </el-select>
                    <el-select v-model="form.county" placeholder="请选择活动区域">
                        <el-option
                                v-for="item in region3"
                                :key="item.area_id"
                                :label="item.name"
                                :value="item.name"
                        ></el-option>
                    </el-select>
                </el-form-item>
              </el-form>
              <div id="xia">
                    <el-button v-if="flag2" type="primary" @click="onSubmit1" size="small">修改信息</el-button>
                    <el-button v-if="flag3" type="primary" @click="onSubmit2" size="small">提交修改</el-button>
                    <el-button v-if="flag4" @click="que" size="small" >取消</el-button>
              </div>
        </div>
    </div>
</body>
<script>
    new Vue({
      el: '#app04',
      created(){
          var url = location.search //获取url中"?"符后的字串 ('?modFlag=business&role=1')
          var theRequest = new Object()
          if (url.indexOf('?') != -1) {
              var str = url.substr(1) //substr()方法返回从参数值开始到结束的字符串；
              var strs = str.split('&')
              for (var i = 0; i < strs.length; i++) {
                  theRequest[strs[i].split('=')[0]] = strs[i].split('=')[1]
              }
              console.log(theRequest) //此时的theRequest就是我们需要的参数；
              // console.log(theRequest.type)
          }
            this.uid=theRequest.id
          axios({
              url:`users/info/${theRequest.id}`,
              method:'GET'
          }).then(result => {
              console.log(result.data.data)
              this.form.account=result.data.data.username
              this.form.password=result.data.data.password
          })

          axios({
              url:'employees/getId',
              method:'GET',
              params:{
                  uid:theRequest.id
              }
          }).then(result => {
              console.log(result.data.data)
              this.id=result.data.data.id
              this.form.name=result.data.data.name
              this.form.age=result.data.data.age
              this.form.phone=result.data.data.phone
              this.form.sex=result.data.data.sex
              this.form.province=result.data.data.province
              this.form.city=result.data.data.city
              this.form.county=result.data.data.county

              this.oldform=JSON.stringify(this.form)
          })
      } ,
        mounted(){

        },
      data () {
      return {
          region1:[],
          region2:[],
          region3:[],
          id:'',
          uid:'',
          form: {
          name: '张三',
          region: '区域二',
          sex:'男',
          age:'',
            province:'',
            city:'',
            county:'',
          phone:'',
            password:'',
            account:'',
          delivery: false,
          resource: '',
        },
        flag1:true,
        flag2:true,
          flag3:false,
          flag4:false,
        oldform:[]
      }
    },
    methods: {
        onSubmit1(){
            this.flag1=false
            this.flag2=false
            this.flag3=true
            this.flag4=true
        },
        onSubmit2() {
        this.sendById(0,1)
            if(JSON.stringify(this.form)!=this.oldform){
                console.log("修改了信息")
                axios({
                    url:'employees',
                    method:'PUT',
                    data:{
                        id:this.id,
                        name:this.form.name,
                        sex:this.form.sex,
                        age:this.form.age,
                        phone:this.form.phone,
                        province:this.form.province,
                        city:this.form.city,
                        county:this.form.county
                    }
                }).then(result => {
                    console.log(result.data.data)
                    this.flag1=true
                    this.flag2=true
                    this.flag3=false
                    this.flag4=false
                })


                axios({
                    url:'users',
                    method: 'PUT',
                    data:{
                        id:this.uid,
                        username:this.form.account,
                        password:this.form.password,
                    }
                }).then(result => {
                    console.log(result.data.data)
                    if(result.data.data==true){
                        this.$message({
                            showClose: true,
                            message: '更新信息成功！',
                            type: 'success'
                        });
                    }
                })

                this.oldform=JSON.stringify(this.form)

            }else{
                console.log("没有改变")
            }
      },
      que(){
        this.flag1=true
        this.flag2=true
          this.flag3=false
          this.flag4=false
      },
        sendById(id,number){
            axios({
                url:`areas/${id}`,
                method:"GET"
            }).then(result => {
                if(number==1){
                    this.region1=result.data.data
                }else if(number==2){
                    this.region2=result.data.data
                }else{
                    this.region3=result.data.data
                }
                // console.log(result.data.data)

            })
        },
        sendByName(name,number){
            const params = new URLSearchParams();
            params.append('name', name);
            if(name!=''){
                axios({
                    url:'areas',
                    method:"POST",
                    data: params,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(result => {
                    this.sendById(result.data.data.area_id,number)
                    // console.log(result.data.data)

                })
            }

        },
    },
        watch:{
            'form.province': {
                handler(newValue,oldValue) {
                    // console.log("旧值为"+oldValue)
                    // console.log("新值为"+newValue)
                    this.sendByName(newValue,2)
                }
            },
            'form.city': {
                handler(newValue,oldValue) {
                    // console.log("旧值为"+oldValue)
                    // console.log("新值为"+newValue)
                    this.sendByName(newValue,3)
                }
            }

        },
    })
</script>

<script>

</script>
</html>